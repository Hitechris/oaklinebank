<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile | Oakline Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .profile-pic {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid #004080;
      margin-bottom: 1rem;
    }
    body.dark-mode {
      background-color: #121212;
      color: #eee;
    }
    body.dark-mode .card {
      background-color: #1e1e1e;
      color: #eee;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #333;
      color: #eee;
      border-color: #555;
    }
    body.dark-mode .btn-primary {
      background-color: #004080;
      border-color: #003366;
    }
  </style>
</head>
<body>

<div class="container mt-5">
  <div class="card shadow">
    <div class="card-header bg-primary text-white text-center">
      <h3>Edit Profile</h3>
    </div>
    <div class="card-body">
      <div class="text-center">
        <img id="profileImage" src="https://via.placeholder.com/150" class="profile-pic" alt="Profile Picture" />
        <input type="file" id="uploadPic" accept="image/*" class="form-control mt-2" />
      </div>

      <form id="profileForm" class="mt-4">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label for="dob" class="form-label">Date of Birth</label>
            <input type="date" id="dob" class="form-control" />
          </div>
          <div class="col-md-6">
            <label for="ssn" class="form-label">SSN</label>
            <input type="text" id="ssn" class="form-control" placeholder="XXX-XX-XXXX" />
          </div>
          <div class="col-md-12">
            <label for="address" class="form-label">Address</label>
            <input type="text" id="address" class="form-control" />
          </div>
          <div class="col-md-6">
            <label for="city" class="form-label">City</label>
            <input type="text" id="city" class="form-control" />
          </div>
          <div class="col-md-6">
            <label for="state" class="form-label">State</label>
            <input type="text" id="state" class="form-control" />
          </div>
        </div>

        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success">Save Profile</button>
          <a href="dashboard.html" class="btn btn-outline-secondary ms-2">Back to Dashboard</a>
        </div>
      </form>

      <hr class="my-4" />

      <div class="mt-4">
        <h4 class="text-center">Your Account Details</h4>
        <div class="row text-center">
          <div class="col-md-6 mb-3">
            <h5>Checking Account</h5>
            <p><strong>Account Number:</strong> <span id="checkingAccountNumberFull">Loading...</span></p>
            <p><strong>Routing Number:</strong> <span id="checkingRoutingNumberFull">Loading...</span></p>
          </div>
          <div class="col-md-6 mb-3">
            <h5>Savings Account</h5>
            <p><strong>Account Number:</strong> <span id="savingsAccountNumberFull">Loading...</span></p>
            <p><strong>Routing Number:</strong> <span id="savingsRoutingNumberFull">Loading...</span></p>
          </div>
        </div>
      </div>

      <hr class="my-4" />

      <h5 class="text-center">Change Password</h5>
      <form id="passwordForm" class="mt-3">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="currentPassword" class="form-label">Current Password</label>
            <input type="password" id="currentPassword" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" id="newPassword" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label for="confirmPassword" class="form-label">Confirm New Password</label>
            <input type="password" id="confirmPassword" class="form-control" required />
          </div>
        </div>
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-warning">Update Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAr4WIWv-sCc96kABTZuzlw67NiwnqTLfo",
    authDomain: "oakline-bank.firebaseapp.com",
    projectId: "oakline-bank",
    storageBucket: "oakline-bank.firebasestorage.app",
    messagingSenderId: "199506974383",
    appId: "1:199506974383:web:3932cbd6bb2b0305b8265a",
    measurementId: "G-XXRQF2N3XB"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser;
  let userDocRef;

  const profileImageElem = document.getElementById('profileImage');
  const uploadPicElem = document.getElementById('uploadPic');

  const checkingAccountNumberFull = document.getElementById('checkingAccountNumberFull');
  const checkingRoutingNumberFull = document.getElementById('checkingRoutingNumberFull');
  const savingsAccountNumberFull = document.getElementById('savingsAccountNumberFull');
  const savingsRoutingNumberFull = document.getElementById('savingsRoutingNumberFull');

  // Elements for profile form
  const profileForm = document.getElementById('profileForm');
  const usernameInput = document.getElementById('username');
  const emailInput = document.getElementById('email');
  const dobInput = document.getElementById('dob');
  const ssnInput = document.getElementById('ssn');
  const addressInput = document.getElementById('address');
  const cityInput = document.getElementById('city');
  const stateInput = document.getElementById('state');

  // Password form elements
  const passwordForm = document.getElementById('passwordForm');
  const currentPasswordInput = document.getElementById('currentPassword');
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');

  function loadUserProfile(user) {
    userDocRef = doc(db, 'users', user.uid);

    getDoc(userDocRef).then(docSnap => {
      if (docSnap.exists()) {
        const data = docSnap.data();

        usernameInput.value = data.username || '';
        emailInput.value = user.email || '';
        dobInput.value = data.dob || '';
        ssnInput.value = data.ssn || '';
        addressInput.value = data.address || '';
        cityInput.value = data.city || '';
        stateInput.value = data.state || '';

        if (data.profileImageURL) {
          profileImageElem.src = data.profileImageURL;
        }

        if(data.accountInfo){
          checkingAccountNumberFull.textContent = data.accountInfo.checking?.accountNumber || "N/A";
          checkingRoutingNumberFull.textContent = data.accountInfo.checking?.routingNumber || "N/A";
          savingsAccountNumberFull.textContent = data.accountInfo.savings?.accountNumber || "N/A";
          savingsRoutingNumberFull.textContent = data.accountInfo.savings?.routingNumber || "N/A";
        } else {
          checkingAccountNumberFull.textContent = "N/A";
          checkingRoutingNumberFull.textContent = "N/A";
          savingsAccountNumberFull.textContent = "N/A";
          savingsRoutingNumberFull.textContent = "N/A";
        }
      } else {
        // New user doc - set defaults if needed
        checkingAccountNumberFull.textContent = "N/A";
        checkingRoutingNumberFull.textContent = "N/A";
        savingsAccountNumberFull.textContent = "N/A";
        savingsRoutingNumberFull.textContent = "N/A";
      }
    }).catch(console.error);
  }

  onAuthStateChanged(auth, user => {
    if (!user) {
      alert('Not logged in');
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;
    loadUserProfile(user);
  });

  // Upload profile picture
  uploadPicElem.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (evt) => {
      const base64String = evt.target.result;
      profileImageElem.src = base64String;

      // Upload to Firebase Storage
      try {
        const imageRef = ref(storage, `profileImages/${currentUser.uid}`);
        await uploadString(imageRef, base64String, 'data_url');

        const url = await getDownloadURL(imageRef);
        await updateDoc(userDocRef, { profileImageURL: url });

        alert('Profile image updated!');
      } catch (error) {
        alert('Failed to upload profile image: ' + error.message);
        console.error(error);
      }
    };
    reader.readAsDataURL(file);
  });

  // Save profile form
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
      await updateDoc(userDocRef, {
        username: usernameInput.value.trim(),
        dob: dobInput.value,
        ssn: ssnInput.value.trim(),
        address: addressInput.value.trim(),
        city: cityInput.value.trim(),
        state: stateInput.value.trim()
      });

      // Update email if changed
      if (emailInput.value.trim() !== currentUser.email) {
        await currentUser.updateEmail(emailInput.value.trim());
      }

      alert('Profile updated successfully!');
    } catch (error) {
      alert('Error updating profile: ' + error.message);
      console.error(error);
    }
  });

  // Change password form
  passwordForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const currentPassword = currentPasswordInput.value;
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (newPassword.length < 6) {
      alert('New password must be at least 6 characters.');
      return;
    }
    if (newPassword !== confirmPassword) {
      alert('New passwords do not match.');
      return;
    }

    try {
      // Re-authenticate user
      const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
      await reauthenticateWithCredential(currentUser, credential);

      // Update password
      await updatePassword(currentUser, newPassword);

      alert('Password updated successfully!');
      passwordForm.reset();
    } catch (error) {
      alert('Failed to update password: ' + error.message);
      console.error(error);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
