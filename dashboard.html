<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | Oakline Bank</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="#">Oakline Bank</a>
    <button class="btn btn-outline-danger ms-auto" id="logoutBtn">Logout</button>
  </div>
</nav>

<div class="container mt-5">
  <h3 id="welcomeMsg"></h3>
  <div id="accountsContainer" class="mt-4"></div>
  <div id="totalBalance" class="mt-3"></div>
  <div id="openAccountLink" class="mt-3"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = 'https://arvuoabjhqdkxhsswybx.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydnVvYWJqaHFka3hoc3N3eWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTQ5MzksImV4cCI6MjA3MTIzMDkzOX0.Gt1waZAhZJKS4_VGqgNQCcroGehjnxKyDUfiCRLSWB8';
const supabase = createClient(supabaseUrl, supabaseKey);

const welcomeMsg = document.getElementById('welcomeMsg');
const accountsContainer = document.getElementById('accountsContainer');
const totalBalanceDiv = document.getElementById('totalBalance');
const logoutBtn = document.getElementById('logoutBtn');
const openAccountLink = document.getElementById('openAccountLink');

async function loadDashboard() {
  const { data: { user }, error: userError } = await supabase.auth.getUser();

  if (userError || !user) {
    window.location.href = 'login.html';
    return;
  }

  // Fetch user profile
  const { data: userProfile, error: profileError } = await supabase
    .from('users')
    .select('*')
    .eq('auth_id', user.id)
    .maybeSingle();

  if (profileError || !userProfile) {
    welcomeMsg.innerText = 'Welcome, user!';
  } else {
    welcomeMsg.innerText = `Welcome, ${userProfile.first_name}!`;
  }

  // Fetch accounts
  const { data: accounts, error: accError } = await supabase
    .from('accounts')
    .select('*')
    .eq('user_id', user.id);

  if (accError) {
    accountsContainer.innerHTML = `<div class="alert alert-danger">Error loading accounts: ${accError.message}</div>`;
    return;
  }

  // No accounts → show link to open account
  if (!accounts || accounts.length === 0) {
    accountsContainer.innerHTML = '<div class="alert alert-warning">No bank accounts found. Please open an account.</div>';
    totalBalanceDiv.innerHTML = '';
    openAccountLink.innerHTML = `<a href="open-account.html" class="btn btn-primary mt-2">Open Account</a>`;
    return;
  }

  // Accounts exist → display them
  let totalBalance = 0;
  accountsContainer.innerHTML = '';
  openAccountLink.innerHTML = ''; // remove open-account button
  accounts.forEach(acc => {
    totalBalance += parseFloat(acc.balance);
    accountsContainer.innerHTML += `
      <div class="card p-3 mb-3">
        <strong>${acc.account_type} Account</strong><br>
        Account Number: ${acc.account_number}<br>
        Routing Number: ${acc.routing_number}<br>
        Balance: $${parseFloat(acc.balance).toFixed(2)}
      </div>
    `;
  });

  totalBalanceDiv.innerHTML = `<div class="alert alert-info">Total Balance: $${totalBalance.toFixed(2)}</div>`;
}

logoutBtn.addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'login.html';
});

// Refresh dashboard every time user returns here
window.addEventListener('focus', loadDashboard);

// Initial load
loadDashboard();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
