<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transaction History - Oakline Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding-bottom: 40px;
    }
    .dark-mode {
      background-color: #121212;
      color: #eee;
    }
    .dark-mode .table {
      color: #eee;
    }
    .dark-mode .btn {
      border-color: #eee;
      color: #eee;
    }
    .btn-toggle-dark {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
    .btn-logout {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: #004080;
      border: none;
      color: white;
    }
    .btn-logout:hover {
      background-color: #002f66;
    }
  </style>
</head>
<body>
  <button class="btn btn-outline-dark btn-sm btn-toggle-dark" aria-label="Toggle dark mode" onclick="toggleDarkMode()">
    <i class="fas fa-moon"></i>
  </button>
  <button id="logoutBtn" class="btn btn-logout btn-sm" aria-label="Logout">Logout</button>

  <div class="container mt-5">
    <h2>Transaction History</h2>
    <p id="welcomeUser"></p>

    <div class="mb-3 row">
      <label for="filterType" class="col-sm-2 col-form-label">Filter by Type:</label>
      <div class="col-sm-4">
        <select id="filterType" class="form-select" aria-label="Filter transactions by type">
          <option value="all">All</option>
          <option value="debit">Debit</option>
          <option value="credit">Credit</option>
        </select>
      </div>

      <label for="filterAccount" class="col-sm-2 col-form-label">Filter by Account:</label>
      <div class="col-sm-4">
        <select id="filterAccount" class="form-select" aria-label="Filter transactions by account">
          <option value="all">All</option>
          <option value="checking">Checking</option>
          <option value="savings">Savings</option>
        </select>
      </div>
    </div>

    <div class="table-responsive" role="region" aria-live="polite" aria-label="Transaction list">
      <table class="table table-striped table-hover" aria-label="Transaction table">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Description</th>
            <th>Type</th>
            <th>Account</th>
            <th>Amount</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="transactionTableBody">
          <!-- Transactions will load here -->
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAr4WIWv-sCc96kABTZuzlw67NiwnqTLfo",
      authDomain: "oakline-bank.firebaseapp.com",
      projectId: "oakline-bank",
      storageBucket: "oakline-bank.appspot.com",
      messagingSenderId: "199506974383",
      appId: "1:199506974383:web:3932cbd6bb2b0305b8265a",
      measurementId: "G-XXRQF2N3XB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Dark mode toggle
    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      const icon = document.querySelector('.btn-toggle-dark i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    };

    // Format date/time nicely
    function formatDate(dateString) {
      if (!dateString) return "N/A";
      const d = new Date(dateString);
      return d.toLocaleString();
    }

    // Format currency
    function formatCurrency(amount) {
      return "$" + Number(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Create details link with tx index
    function createDetailsLink(index) {
      return `<a href="receipt.html?tx=${index}" class="btn btn-sm btn-primary" aria-label="View receipt for transaction ${index}">View Receipt</a>`;
    }

    // Render transactions in table
    function renderTransactions(transactions, filterType, filterAccount) {
      const tbody = document.getElementById('transactionTableBody');
      tbody.innerHTML = '';

      if (!transactions || transactions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No transactions found.</td></tr>`;
        return;
      }

      let filtered = transactions;

      if (filterType && filterType !== 'all') {
        filtered = filtered.filter(tx => tx.type && tx.type.toLowerCase() === filterType.toLowerCase());
      }

      if (filterAccount && filterAccount !== 'all') {
        filtered = filtered.filter(tx => {
          // Some transactions might have 'account', others might have 'fromAccount' or 'toAccount'.
          // We'll check account, fromAccount, and toAccount fields.
          const accounts = [tx.account, tx.fromAccount, tx.toAccount].filter(Boolean).map(a => a.toLowerCase());
          return accounts.includes(filterAccount.toLowerCase());
        });
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No transactions match the filter criteria.</td></tr>`;
        return;
      }

      // Show newest first:
      filtered.slice().reverse().forEach((tx, i) => {
        // We want the original index in transactions for the receipt link.
        const originalIndex = transactions.indexOf(tx);
        const typeCapitalized = tx.type ? tx.type.charAt(0).toUpperCase() + tx.type.slice(1) : "N/A";
        const accountDisplay = tx.account || tx.fromAccount || tx.toAccount || "N/A";
        const accountCapitalized = accountDisplay.charAt(0).toUpperCase() + accountDisplay.slice(1);
        const amountSign = (tx.type && tx.type.toLowerCase() === 'debit') ? '-' : '+';
        const amountColor = (tx.type && tx.type.toLowerCase() === 'debit') ? '#dc3545' : '#28a745';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(tx.date)}</td>
          <td>${tx.description || "N/A"}</td>
          <td>${typeCapitalized}</td>
          <td>${accountCapitalized}</td>
          <td style="color:${amountColor};">${amountSign}${formatCurrency(tx.amount || 0)}</td>
          <td>${createDetailsLink(originalIndex)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const username = localStorage.getItem('loggedInUser');
      if (!username) {
        alert('Not logged in');
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('welcomeUser').textContent = `Welcome, ${username}!`;

      // Fetch user data from Firestore
      try {
        const userDocRef = doc(db, "users", username);
        const userDocSnap = await getDoc(userDocRef);

        if (!userDocSnap.exists()) {
          alert('User data not found.');
          localStorage.removeItem('loggedInUser');
          window.location.href = 'index.html';
          return;
        }

        const userData = userDocSnap.data();
        const transactions = userData.transactions || [];

        const filterTypeSelect = document.getElementById('filterType');
        const filterAccountSelect = document.getElementById('filterAccount');

        function updateTable() {
          renderTransactions(transactions, filterTypeSelect.value, filterAccountSelect.value);
        }

        filterTypeSelect.addEventListener('change', updateTable);
        filterAccountSelect.addEventListener('change', updateTable);

        updateTable();
      } catch (error) {
        console.error('Error loading transactions:', error);
        alert('Failed to load transactions. Please try again later.');
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('loggedInUser');
        window.location.href = 'index.html';
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
