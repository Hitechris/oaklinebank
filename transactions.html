<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transaction History - Oakline Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    table th, table td { vertical-align: middle; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-light px-3">
    <a href="index.html" class="navbar-brand">Oakline Bank</a>
    <div class="dropdown">
      <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-bars me-1"></i> Menu
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="dashboard.html">Dashboard</a></li>
        <li><a class="dropdown-item" href="deposit.html">Deposit Funds</a></li>
        <li><a class="dropdown-item" href="withdrawal.html">Withdraw Funds</a></li>
        <li><a class="dropdown-item" href="index.html">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container mt-5">
    <h4 class="mb-4">All Transactions</h4>

    <div class="d-flex justify-content-between align-items-center my-3 flex-wrap">
  <div class="mb-2">
    <label for="filterType" class="form-label me-2">Filter by Type:</label>
    <select id="filterType" class="form-select form-select-sm d-inline-block w-auto">
      <option value="All">All</option>
      <option value="Deposit">Deposit</option>
      <option value="Withdrawal">Withdrawal</option>
      <option value="Transfer">Transfer</option>
    </select>
  </div>
  <button class="btn btn-outline-primary btn-sm mb-2" onclick="exportToCSV()">
    <i class="fas fa-file-export me-1"></i> Export to CSV
  </button>
</div>
    <!-- FILTER & EXPORT CONTROLS -->
<div class="row mb-3">
  <div class="col-md-4 mb-2">
    <label for="filterType" class="form-label">Filter by Type:</label>
    <select id="filterType" class="form-select form-select-sm">
      <option value="All">All</option>
      <option value="Deposit">Deposit</option>
      <option value="Withdrawal">Withdrawal</option>
      <option value="Transfer">Transfer</option>
    </select>
  </div>
  <div class="col-md-3 mb-2">
    <label for="startDate" class="form-label">From:</label>
    <input type="date" id="startDate" class="form-control form-control-sm" />
  </div>
  <div class="col-md-3 mb-2">
    <label for="endDate" class="form-label">To:</label>
    <input type="date" id="endDate" class="form-control form-control-sm" />
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button class="btn btn-outline-primary btn-sm w-100" onclick="exportToCSV()">
      <i class="fas fa-file-export me-1"></i> Export CSV
    </button>
  </div>
</div>
    <div class="table-responsive">
      <table class="table table-bordered table-hover text-center align-middle">
<thead class="table-light">
  <tr>
    <th>Date</th>
    <th>Type</th>
    <th>Description</th>
    <th>Amount ($)</th>
    <th>Balance After</th>
    <th>Receipt</th> <!-- âœ… New column -->
  </tr>
</thead>
        <tbody id="transactionTableBody"></tbody>
      </table>
    </div>
    <div id="noTransactions" class="text-muted text-center mt-4 d-none">
      No transactions yet.
    </div>
  </div>

<script>
  const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
  const tbody = document.getElementById('transactionTableBody');
  const empty = document.getElementById('noTransactions');

  const filterSelect = document.getElementById('filterType');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');

  function parseDate(dateStr) {
    return new Date(dateStr + 'T00:00:00');
  }

  function renderTransactions() {
    tbody.innerHTML = '';
    empty.classList.add('d-none');
    let runningBalance = 0;

    const typeFilter = filterSelect.value;
    const startDate = startDateInput.value ? parseDate(startDateInput.value) : null;
    const endDate = endDateInput.value ? parseDate(endDateInput.value) : null;

    // Newest-first
    const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

    const filtered = sorted.filter(tx => {
      const txDate = new Date(tx.date);
      const matchesType = typeFilter === "All" || tx.type === typeFilter;
      const matchesStart = !startDate || txDate >= startDate;
      const matchesEnd = !endDate || txDate <= endDate;
      return matchesType && matchesStart && matchesEnd;
    });

    if (filtered.length === 0) {
      empty.classList.remove('d-none');
      return;
    }

    filtered.forEach((tx, index) => {
      if (tx.type && tx.type.toLowerCase() === "deposit") {
        runningBalance += parseFloat(tx.amount);
      } else if (tx.type && (tx.type.toLowerCase() === "withdrawal" || tx.type.toLowerCase() === "transfer")) {
        runningBalance -= parseFloat(tx.amount);
      }

      const row = document.createElement('tr');

      const receiptBtn = tx.type && tx.type.toLowerCase() === "transfer"
        ? `<button class="btn btn-sm btn-outline-secondary" onclick="viewReceipt(${transactions.indexOf(tx)})" title="View Receipt">
             <i class="fas fa-receipt"></i>
           </button>`
        : "";

      const isDeposit = tx.type && tx.type.toLowerCase() === 'deposit';
      const amountClass = isDeposit ? 'text-success' : 'text-danger';
      const sign = isDeposit ? '+' : '-';

      row.innerHTML = `
        <td>${tx.date}</td>
        <td>${tx.type}</td>
        <td>${tx.description || '-'}</td>
        <td class="${amountClass}">
          ${sign}$${parseFloat(tx.amount).toFixed(2)}
        </td>
        <td>$${runningBalance.toFixed(2)}</td>
        <td>${receiptBtn}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function viewReceipt(index) {
    const tx = transactions[index];
    localStorage.setItem('latestTransaction', JSON.stringify(tx));
    window.location.href = "receipt.html";
  }

  function exportToCSV() {
    if (transactions.length === 0) return alert("No transactions to export.");

    const csvRows = [["Date", "Type", "Description", "Amount", "Balance"]];
    let runningBalance = 0;

    const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

    sorted.forEach(tx => {
      if (tx.type && tx.type.toLowerCase() === "deposit") runningBalance += parseFloat(tx.amount);
      else if (tx.type && (tx.type.toLowerCase() === "withdrawal" || tx.type.toLowerCase() === "transfer")) runningBalance -= parseFloat(tx.amount);

      csvRows.push([
        tx.date,
        tx.type,
        tx.description || '',
        (tx.type && tx.type.toLowerCase() === "deposit" ? '+' : '-') + parseFloat(tx.amount).toFixed(2),
        runningBalance.toFixed(2)
      ]);
    });

    const csvContent = "data:text/csv;charset=utf-8," + csvRows.map(r => r.join(",")).join("\n");
    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    link.download = "oakline-transactions.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  filterSelect.addEventListener('change', renderTransactions);
  startDateInput.addEventListener('change', renderTransactions);
  endDateInput.addEventListener('change', renderTransactions);

  renderTransactions();
</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
