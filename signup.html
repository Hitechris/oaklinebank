<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Oakline Bank - Sign Up</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; padding: 20px; transition: background 0.3s, color 0.3s;}
  .dark-mode { background-color: #121212; color: #eee; }
  .signup-box { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); transition: background 0.3s, color 0.3s; }
  .dark-mode .signup-box { background-color: #1e1e1e; color: #fff; }
  h3 { color: #004080; margin-bottom: 20px; text-align: center; }
  .btn-primary { background-color: #004080; border-color: #004080; }
  .btn-primary:hover { background-color: #003366; }
  .form-label { font-weight: 500; }
  .form-control, .form-select { border-radius: 6px; border: 1px solid #ccc; padding: 8px 12px; }
  #message { font-weight: 600; margin-top: 15px; text-align: center; }
  .top-controls-left { position: fixed; top: 10px; left: 10px; z-index: 1000; }
</style>
</head>
<body>

<div class="top-controls-left">
  <button class="btn btn-outline-dark btn-sm" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
    <i class="fas fa-moon"></i>
  </button>
</div>

<div class="signup-box">
  <h3>Create Your Oakline Bank Account</h3>

  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">First Name</label>
      <input type="text" class="form-control" id="firstName" placeholder="John">
    </div>
    <div class="col-md-4">
      <label class="form-label">Middle Name</label>
      <input type="text" class="form-control" id="middleName" placeholder="M.">
    </div>
    <div class="col-md-4">
      <label class="form-label">Last Name</label>
      <input type="text" class="form-control" id="lastName" placeholder="Doe">
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <label class="form-label">Username</label>
      <input type="text" class="form-control" id="username" placeholder="johndoe">
    </div>
    <div class="col-md-6">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" id="email" placeholder="john@example.com">
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <label class="form-label">Password</label>
      <input type="password" class="form-control" id="password" placeholder="Enter password">
    </div>
    <div class="col-md-6">
      <label class="form-label">Confirm Password</label>
      <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm password">
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <label class="form-label">SSN</label>
      <input type="text" class="form-control" id="ssn" placeholder="123-45-6789">
    </div>
    <div class="col-md-6">
      <label class="form-label">Phone</label>
      <input type="text" class="form-control" id="phone" placeholder="(123) 456-7890">
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-4">
      <label class="form-label">City</label>
      <input type="text" class="form-control" id="city" placeholder="New York">
    </div>
    <div class="col-md-4">
      <label class="form-label">State</label>
      <input type="text" class="form-control" id="state" placeholder="NY">
    </div>
    <div class="col-md-4">
      <label class="form-label">Country</label>
      <input type="text" class="form-control" id="country" placeholder="USA">
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <label class="form-label">Date of Birth</label>
      <input type="date" class="form-control" id="dob">
    </div>
    <div class="col-md-6">
      <label class="form-label">Account Type</label>
      <select class="form-select" id="accountType">
        <option value="checking">Checking</option>
        <option value="savings">Savings</option>
        <option value="both">Both</option>
      </select>
    </div>
  </div>

  <div class="d-grid mt-3">
    <button class="btn btn-primary" id="signupBtn"><i class="fas fa-user-plus me-1"></i> Sign Up</button>
  </div>

  <div id="message"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = 'https://ockhxxigrqmbuotkupfl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ja2h4eGlncnFtYnVvdGt1cGZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTEzNzYsImV4cCI6MjA3MTA4NzM3Nn0.ZQaEXgJ2jLFFErI3eTY53cMaQrf1w19GhuGyN31WAOw';
const supabase = createClient(supabaseUrl, supabaseKey);

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

// Generate random account number
function generateAccountNumber() {
  return 'AC' + Math.floor(100000000 + Math.random() * 900000000);
}

async function signup() {
  const firstName = document.getElementById('firstName').value.trim();
  const middleName = document.getElementById('middleName').value.trim();
  const lastName = document.getElementById('lastName').value.trim();
  const username = document.getElementById('username').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const ssn = document.getElementById('ssn').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const city = document.getElementById('city').value.trim();
  const state = document.getElementById('state').value.trim();
  const country = document.getElementById('country').value.trim();
  const dob = document.getElementById('dob').value;
  const accountType = document.getElementById('accountType').value;

  const messageDiv = document.getElementById('message');

  if (!firstName || !lastName || !username || !email || !password || !confirmPassword || !ssn || !city || !state || !country || !dob) {
    messageDiv.innerHTML = "<span class='text-danger'>Please fill all required fields.</span>";
    return;
  }

  if (password !== confirmPassword) {
    messageDiv.innerHTML = "<span class='text-danger'>Passwords do not match.</span>";
    return;
  }

  // 1️⃣ Create user in Supabase Auth
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email,
    password,
    options: { data: { username } }
  });

  if (authError) {
    console.error(authError);
    messageDiv.innerHTML = "<span class='text-danger'>Signup failed: " + authError.message + "</span>";
    return;
  }

  const userId = authData.user.id;

  // 2️⃣ Insert profile data
  const { data: profileData, error: profileError } = await supabase
    .from('profiles')
    .insert([{
      id: userId,
      first_name: firstName,
      middle_name: middleName,
      last_name: lastName,
      username,
      email,
      ssn,
      phone,
      city,
      state,
      country,
      dob
    }]);

  if (profileError) {
    console.error(profileError);
    messageDiv.innerHTML = "<span class='text-danger'>Profile creation failed.</span>";
    return;
  }

  // 3️⃣ Insert accounts
  const accountsToInsert = [];
  if (accountType === 'checking' || accountType === 'both') {
    accountsToInsert.push({ user_id: userId, account_number: generateAccountNumber(), type: 'checking', routing_number: '075915826', balance: 0 });
  }
  if (accountType === 'savings' || accountType === 'both') {
    accountsToInsert.push({ user_id: userId, account_number: generateAccountNumber(), type: 'savings', routing_number: '075915826', balance: 0 });
  }

  const { data: accountData, error: accountError } = await supabase
    .from('accounts')
    .insert(accountsToInsert);

  if (accountError) {
    console.error(accountError);
    messageDiv.innerHTML = "<span class='text-danger'>Account creation failed.</span>";
    return;
  }

  messageDiv.innerHTML = "<span class='text-success'>Signup successful! You can now log in.</span>";

  // Optional: redirect after short delay
  setTimeout(() => {
    window.location.href = 'login.html';
  }, 2000);
}

document.getElementById('signupBtn').addEventListener('click', signup);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
