<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Up | Oakline Bank</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f9fbff; margin: 0; }
    .navbar { display:flex; justify-content:space-between; align-items:center; padding:15px 40px; background:#003366; color:#fff; }
    .navbar .logo { font-size:1.5rem; font-weight:700; }
    .form-container { max-width: 560px; margin: 40px auto; background: #fff; padding: 28px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,.08); }
    h2 { text-align:center; color:#003366; margin-bottom: 16px; }
    input, select { margin-bottom: 12px; padding: 10px; width: 100%; border-radius: 6px; border: 1px solid #ccc; }
    button { background:#0052cc; color:#fff; border:none; padding:12px; width:100%; border-radius:6px; font-weight:700; }
    button:hover { background:#003e9e; }
    .error { color: #c1121f; margin-top: 8px; text-align:center; display:none; }
    .hint { font-size:.9rem; color:#555; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">Oakline Bank</div>
  </header>

  <div class="form-container">
    <h2>Create Your Oakline Account</h2>
    <p id="signupError" class="error"></p>

    <form id="signupForm" autocomplete="off">
      <input type="text" id="firstName" placeholder="First Name" required>
      <input type="text" id="middleName" placeholder="Middle Name">
      <input type="text" id="lastName" placeholder="Last Name" required>

      <input type="text" id="username" placeholder="Username" required>
      <input type="email" id="email" placeholder="Email" required>

      <input type="password" id="password" placeholder="Password" required>
      <input type="password" id="confirmPassword" placeholder="Confirm Password" required>

      <input type="text" id="ssn" placeholder="SSN" required>
      <input type="text" id="phone" placeholder="Phone Number" required>

      <input type="text" id="address" placeholder="Address" required>
      <input type="text" id="city" placeholder="City" required>
      <input type="text" id="state" placeholder="State" required>
      <input type="text" id="country" placeholder="Country" required>

      <label for="accountType" class="mt-2">Select Account Type:</label>
      <select id="accountType" required>
        <option value="">-- Select --</option>
        <option value="checking">Checking</option>
        <option value="savings">Savings</option>
        <option value="both">Both</option>
      </select>

      <button type="submit">Sign Up</button>
      <p class="hint mt-2 text-center">You’ll get a confirmation email, but login is still allowed if you’ve set your project to not require confirmed emails.</p>
      <p class="mt-3 text-center">Already have an account? <a href="login.html">Login</a></p>
    </form>
  </div>

  <script>
    // --- Supabase client (uses your project URL + anon key) ---
    const supabaseUrl = "https://ockhxxigrqmbuotkupfl.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ja2h4eGlncnFtYnVvdGt1cGZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTEzNzYsImV4cCI6MjA3MTA4NzM3Nn0.ZQaEXgJ2jLFFErI3eTY53cMaQrf1w19GhuGyN31WAOw";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const form = document.getElementById("signupForm");
    const errorEl = document.getElementById("signupError");

    // helper: sha256 -> hex (to populate profiles.password_hash)
    async function sha256Hex(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // helper: generate 10-digit account number
    function genAcct() {
      return String(Math.floor(1000000000 + Math.random() * 9000000000));
    }

    // helper: insert one account, retry on unique conflict a few times
    async function insertAccount(userId, type) {
      const routing = "075915826";
      for (let i = 0; i < 5; i++) {
        const account_number = genAcct();
        const { error } = await supabase.from("accounts").insert([
          { user_id: userId, type, balance: 0, account_number, routing_number: routing }
        ]);
        if (!error) return;
        // if unique violation, retry; otherwise throw
        if (!(error && error.code === "23505")) throw error;
      }
      throw new Error("Could not generate a unique account number. Please try again.");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.style.display = "none";
      errorEl.textContent = "";

      const userData = {
        first_name: document.getElementById("firstName").value.trim(),
        middle_name: document.getElementById("middleName").value.trim(),
        last_name: document.getElementById("lastName").value.trim(),
        username: document.getElementById("username").value.trim(),
        email: document.getElementById("email").value.trim(),
        password: document.getElementById("password").value,
        confirmPassword: document.getElementById("confirmPassword").value,
        ssn: document.getElementById("ssn").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        city: document.getElementById("city").value.trim(),
        state: document.getElementById("state").value.trim(),
        country: document.getElementById("country").value.trim(),
        account_type: document.getElementById("accountType").value
      };

      if (userData.password !== userData.confirmPassword) {
        errorEl.textContent = "Passwords do not match.";
        errorEl.style.display = "block";
        return;
      }
      if (!userData.account_type) {
        errorEl.textContent = "Please select an account type.";
        errorEl.style.display = "block";
        return;
      }

      try {
        // 1) Create Auth user (this triggers confirmation email if enabled)
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email: userData.email,
          password: userData.password,
          options: {
            data: {
              username: userData.username,
              full_name: `${userData.first_name} ${userData.middle_name} ${userData.last_name}`.replace(/\s+/g, " ").trim()
            }
          }
        });
        if (authError) throw authError;
        const userId = authData.user.id;

        // 2) Insert profile row (RLS policy must allow: WITH CHECK auth.uid() = id)
        const password_hash = await sha256Hex(userData.password); // populate required column
        const { error: profileErr } = await supabase.from("profiles").insert([{
          id: userId,
          email: userData.email,
          username: userData.username,
          password_hash,
          first_name: userData.first_name,
          middle_name: userData.middle_name,
          last_name: userData.last_name,
          ssn: userData.ssn,
          phone: userData.phone,
          address: userData.address,
          city: userData.city,
          state: userData.state,
          country: userData.country
          // created_at uses default now()
        }]);
        if (profileErr) throw profileErr;

        // 3) Create account(s)
        if (userData.account_type === "checking" || userData.account_type === "both") {
          await insertAccount(userId, "checking");
        }
        if (userData.account_type === "savings" || userData.account_type === "both") {
          await insertAccount(userId, "savings");
        }

        alert("Signup successful! Check your email for confirmation. You can log in now.");
        window.location.href = "login.html";
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Signup failed: " + (err?.message || "Unexpected error");
        errorEl.style.display = "block";
      }
    });
  </script>
</body>
</html>
