<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Open New Account - Oakline Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 480px; margin-top: 3rem; }
    .header { text-align: center; margin-bottom: 2rem; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>Open a New Account</h2>
    <p class="text-muted">Create a Checking or Savings account</p>
  </div>

  <form id="openAccountForm">
    <div class="mb-3">
      <label for="accountType" class="form-label">Account Type</label>
      <select class="form-select" id="accountType" required>
        <option value="">Select account type</option>
        <option value="checking">Checking</option>
        <option value="savings">Savings</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="initialDeposit" class="form-label">Initial Deposit ($)</label>
      <input type="number" class="form-control" id="initialDeposit" min="0" value="0">
    </div>

    <button type="submit" class="btn btn-primary w-100">
      <i class="fas fa-plus-circle me-1"></i> Open Account
    </button>
  </form>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ==================== Supabase Config ====================
  const supabaseUrl = 'https://ockhxxigrqmbuotkupfl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // anon key
  const supabase = createClient(supabaseUrl, supabaseKey);

  // ==================== Auth State ====================
  let currentUser = null;

  // Listen for auth state changes
  supabase.auth.onAuthStateChange((event, session) => {
    if (session && session.user) {
      currentUser = session.user;
    } else {
      // Not logged in, redirect
      window.location.href = 'login.html';
    }
  });

  // Utility function to get current user
  async function getUser() {
    if (currentUser) return currentUser;

    const { data: session } = await supabase.auth.getSession();
    if (!session || !session.user) {
      window.location.href = 'login.html';
      return null;
    }
    currentUser = session.user;
    return currentUser;
  }

  // ==================== Account Number Generator ====================
  function generateAccountNumber() {
    const prefix = "10"; // can vary for checking/savings
    const randomPart = Math.floor(10000000 + Math.random() * 90000000); // 8 digits
    return prefix + randomPart; // 10-digit account number
  }

  // ==================== Form Submission ====================
  document.getElementById('openAccountForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const user = await getUser();
    if (!user) return; // wait until user is loaded

    const type = document.getElementById('accountType').value;
    const deposit = parseFloat(document.getElementById('initialDeposit').value) || 0;
    const accountNumber = generateAccountNumber();
    const routingNumber = '021000021'; // demo routing number

    try {
      // Insert new account
      const { data: newAccount, error: accountError } = await supabase
        .from('accounts')
        .insert([{
          user_id: user.id,
          type: type,
          balance: deposit,
          account_number: accountNumber,
          routing_number: routingNumber
        }])
        .select()
        .single();

      if (accountError) throw accountError;

      // Record opening transaction if deposit > 0
      if (deposit > 0) {
        await supabase.from('transactions').insert([{
          user_id: user.id,
          account_id: newAccount.id,
          type: 'deposit',
          amount: deposit,
          description: 'Initial deposit'
        }]);
      }

      alert(`Success! Your new ${type} account has been created.`);
      window.location.href = 'dashboard.html';

    } catch (err) {
      console.error(err);
      alert('Error creating account. Please try again.');
    }
  });
</script>

</body>
</html>
