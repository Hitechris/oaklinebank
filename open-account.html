<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Account | Oakline Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.7.0/dist/supabase.min.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; background: #f4f6f9; }
    .form-container { max-width: 700px; margin: 50px auto; padding: 30px; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .form-title { text-align: center; margin-bottom: 25px; color: #004080; }
    .btn-primary { background-color: #004080; border: none; }
    .btn-primary:hover { background-color: #0066cc; }
    .account-types label { margin-right: 15px; }
    .account-confirmation { margin-top: 30px; }
    .account-card { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2 class="form-title">Open an Oakline Bank Account</h2>
    <form id="openAccountForm">
      <div class="row mb-3">
        <div class="col"><input type="text" class="form-control" placeholder="First Name" name="firstName" required></div>
        <div class="col"><input type="text" class="form-control" placeholder="Middle Name" name="middleName"></div>
        <div class="col"><input type="text" class="form-control" placeholder="Last Name" name="lastName" required></div>
      </div>

      <div class="mb-3"><input type="date" class="form-control" name="dob" placeholder="Date of Birth" required></div>
      <div class="mb-3"><input type="tel" class="form-control" name="phone" placeholder="Phone Number" required></div>
      <div class="mb-3"><input type="email" class="form-control" name="email" placeholder="Email Address" required></div>
      <div class="mb-3"><input type="text" class="form-control" name="address" placeholder="Address" required></div>

      <div class="row mb-3">
        <div class="col"><input type="text" class="form-control" name="city" placeholder="City" required></div>
        <div class="col"><input type="text" class="form-control" name="state" placeholder="State" required></div>
        <div class="col"><input type="text" class="form-control" name="postalCode" placeholder="Postal Code" required></div>
      </div>

      <div class="mb-3"><input type="text" class="form-control" name="ssn" placeholder="SSN" required></div>

      <div class="mb-3 account-types">
        <label><input type="checkbox" name="accountType" value="Savings"> Savings</label>
        <label><input type="checkbox" name="accountType" value="Checking"> Checking</label>
        <label><input type="checkbox" name="accountType" value="Business"> Business</label>
      </div>

      <button type="submit" class="btn btn-primary w-100">Open Account</button>
      <a href="enroll.html" class="btn btn-outline-primary w-100 mt-2">Go to Online Banking Enrollment</a>
    </form>

    <div class="account-confirmation" id="accountConfirmation" style="display:none;">
      <h3 style="text-align:center; color:#004080;">Your Accounts Have Been Created</h3>
      <div id="accountList"></div>
      <a href="enroll.html" class="btn btn-primary w-100 mt-3">Proceed to Online Banking Enrollment</a>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://arvuoabjhqdkxhsswybx.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydnVvYWJqaHFka3hoc3N3eWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTQ5MzksImV4cCI6MjA3MTIzMDkzOX0.Gt1waZAhZJKS4_VGqgNQCcroGehjnxKyDUfiCRLSWB8';
    const supabase = Supabase.createClient(supabaseUrl, supabaseAnonKey);

    const form = document.getElementById('openAccountForm');
    const confirmationDiv = document.getElementById('accountConfirmation');
    const accountListDiv = document.getElementById('accountList');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      const email = formData.get('email');
      const ssn = formData.get('ssn');

      // Check if email or SSN already exists
      const { data: existing, error: checkError } = await supabase.from('accounts')
        .select('id, account_type')
        .or(`email.eq.${email},ssn.eq.${ssn}`);

      if (checkError) {
        alert('Error checking existing accounts: ' + checkError.message);
        return;
      }

      if (existing.length > 0) {
        alert('An account with this Email or SSN already exists.');
        return;
      }

      // Collect selected account types
      const accountTypes = [];
      form.querySelectorAll('input[name="accountType"]:checked').forEach(cb => accountTypes.push(cb.value));
      if(accountTypes.length === 0){
        alert("Please select at least one account type.");
        return;
      }

      const createdAccounts = [];

      for(const type of accountTypes){
        const accountNumber = 'OB-' + Math.floor(1000000000 + Math.random() * 9000000000);

        const { data, error } = await supabase.from('accounts').insert([
          {
            first_name: formData.get('firstName'),
            middle_name: formData.get('middleName'),
            last_name: formData.get('lastName'),
            dob: formData.get('dob'),
            phone: formData.get('phone'),
            email: email,
            address: formData.get('address'),
            city: formData.get('city'),
            state: formData.get('state'),
            postal_code: formData.get('postalCode'),
            ssn: ssn,
            account_type: type,
            account_number: accountNumber,
            routing_number: '075915826'
          }
        ]);

        if(error){
          alert('Error creating ' + type + ' account: ' + error.message);
        } else {
          createdAccounts.push(data[0]);
        }
      }

      if(createdAccounts.length > 0){
        form.style.display = 'none';
        confirmationDiv.style.display = 'block';
        accountListDiv.innerHTML = '';

        createdAccounts.forEach(acc => {
          const card = document.createElement('div');
          card.className = 'account-card';
          card.innerHTML = `
            <p><strong>Account Type:</strong> ${acc.account_type}</p>
            <p><strong>Account Number:</strong> ${acc.account_number}</p>
            <p><strong>Routing Number:</strong> ${acc.routing_number}</p>
          `;
          accountListDiv.appendChild(card);
        });
      }
    });
  </script>
</body>
</html>
