<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Dashboard - Oakline Bank</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; padding: 20px; }
  h1, h2 { color: #004080; }
  .section { background: white; border-radius: 8px; padding: 15px; margin-bottom: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
  .btn-approve { background-color: #28a745; color: white; }
  .btn-approve:hover { background-color: #218838; }
  .btn-reject { background-color: #dc3545; color: white; }
  .btn-reject:hover { background-color: #c82333; }
  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .logo { font-size: 24px; font-weight: 700; color: #004080; }
</style>
</head>
<body>

<div class="top-bar">
  <div class="logo">Oakline Admin Panel</div>
  <div>
    <a href="dashboard.html" class="btn btn-primary me-2">Go to Dashboard</a>
    <button class="btn btn-danger" id="logoutBtn">Logout</button>
  </div>
</div>

<div class="section">
  <h2>Total Registered Users</h2>
  <p id="totalUsersCount">Loading...</p>
</div>

<div class="section">
  <h2>Users & Balances</h2>
  <div id="usersList">Loading users...</div>
</div>

<div class="section">
  <h2>Pending Deposits</h2>
  <div id="pendingDepositsList">Loading pending deposits...</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = 'https://ockhxxigrqmbuotkupfl.supabase.co';
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // <-- Replace with your actual key
const supabase = createClient(supabaseUrl, supabaseKey);

// Logout button
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'admin-login.html';
});

// Load users & balances
async function loadUsers() {
  const { data: users, error } = await supabase.from('profiles').select('id, email, is_admin');
  if (error) return console.error(error);

  document.getElementById('totalUsersCount').innerText = users.length;

  const usersListDiv = document.getElementById('usersList');
  usersListDiv.innerHTML = '';

  for (let user of users) {
    const { data: accounts } = await supabase.from('accounts').select('type, balance, account_number, routing_number').eq('user_id', user.id);
    const balancesHtml = accounts.map(a => `<div><strong>${a.type}:</strong> $${a.balance.toFixed(2)} (${a.account_number})</div>`).join('');
    usersListDiv.innerHTML += `
      <div class="mb-3 p-2 border rounded">
        <strong>${user.email}</strong>${user.is_admin ? ' (Admin)' : ''}<br/>
        ${balancesHtml}
      </div>
    `;
  }
}

// Load pending deposits
async function loadPendingDeposits() {
  const { data: deposits, error } = await supabase
    .from('deposits')
    .select('*')
    .eq('status', 'Pending')
    .order('created_at', { ascending: true });

  const container = document.getElementById('pendingDepositsList');
  container.innerHTML = '';

  if (error) return console.error(error);
  if (!deposits || deposits.length === 0) {
    container.innerHTML = '<p>No pending deposits.</p>';
    return;
  }

  for (let dep of deposits) {
    const div = document.createElement('div');
    div.className = 'mb-3 p-2 border rounded d-flex justify-content-between align-items-center';
    div.innerHTML = `
      <div>
        <strong>${dep.email}</strong> - ${dep.account_type} - $${dep.amount.toFixed(2)}
        <br/><small>Submitted: ${new Date(dep.created_at).toLocaleString()}</small>
      </div>
      <div>
        <button class="btn btn-approve btn-sm me-1">Approve</button>
        <button class="btn btn-reject btn-sm">Reject</button>
      </div>
    `;

    const approveBtn = div.querySelector('.btn-approve');
    const rejectBtn = div.querySelector('.btn-reject');

    approveBtn.addEventListener('click', async () => {
      // Get account
      let { data: account, error: accErr } = await supabase
        .from('accounts')
        .select('*')
        .eq('user_id', dep.user_id)
        .eq('type', dep.account_type)
        .single();

      if (accErr) {
        console.error(accErr);
        alert('Error fetching user account.');
        return;
      }

      // Update balance
      const newBalance = account.balance + dep.amount;
      await supabase
        .from('accounts')
        .update({ balance: newBalance })
        .eq('id', account.id);

      // Mark deposit approved
      await supabase
        .from('deposits')
        .update({ status: 'Approved' })
        .eq('id', dep.id);

      loadPendingDeposits();
      loadUsers();
    });

    rejectBtn.addEventListener('click', async () => {
      await supabase
        .from('deposits')
        .update({ status: 'Rejected' })
        .eq('id', dep.id);

      loadPendingDeposits();
    });

    container.appendChild(div);
  }
}

// Initial load
loadUsers();
loadPendingDeposits();

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
